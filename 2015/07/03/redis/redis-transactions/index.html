<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="J07Rx2NjTiwjIyxdGuCALSCM2Kzq294kYmnj1f4Izoc" />










  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="/fonts/fonts.css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  




<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="redis," />





  <link rel="alternate" href="/atom.xml" title="HEXH's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="MULTI, EXEC, DISCARD and WATCH are the foundation of transactions in Redis. They allow the execution of a group of commands in a single step, with two important guarantees:

All the commands in a tran">
<meta property="og:type" content="article">
<meta property="og:title" content="redis-transactions">
<meta property="og:url" content="http://dangxia.github.io/2015/07/03/redis/redis-transactions/index.html">
<meta property="og:site_name" content="HEXH's Blog">
<meta property="og:description" content="MULTI, EXEC, DISCARD and WATCH are the foundation of transactions in Redis. They allow the execution of a group of commands in a single step, with two important guarantees:

All the commands in a tran">
<meta property="og:updated_time" content="2016-04-15T14:31:23.994Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="redis-transactions">
<meta name="twitter:description" content="MULTI, EXEC, DISCARD and WATCH are the foundation of transactions in Redis. They allow the execution of a group of commands in a single step, with two important guarantees:

All the commands in a tran">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"hide"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> redis-transactions | HEXH's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-64562250-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?192da5f5f63c7884ac9970b2d7d49848";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">HEXH's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">面朝大海，春暖花开</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-heartbeat fa-fw"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                redis-transactions
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-07-03T10:40:36+08:00" content="2015-07-03">
              2015-07-03
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/07/03/redis/redis-transactions/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/07/03/redis/redis-transactions/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><a href="http://redis.io/commands/multi" target="_blank" rel="external">MULTI</a>, <a href="http://redis.io/commands/exec" target="_blank" rel="external">EXEC</a>, <a href="http://redis.io/commands/discard" target="_blank" rel="external">DISCARD</a> and <a href="http://redis.io/commands/watch" target="_blank" rel="external">WATCH</a> are the foundation of transactions in Redis. They allow the execution of a group of commands in a single step, with two important guarantees:</p>
<ul>
<li>All the commands in a transaction are serialized and executed sequentially. It can never happen that a request issued by another client is served <strong>in the middle of</strong> the execution of a Redis transaction. This guarantees that the commands are executed as a single isolated operation.</li>
<li>Either all of the commands or none are processed, so a Redis transaction is also atomic. The <a href="http://redis.io/commands/exec" target="_blank" rel="external">EXEC</a> command triggers the execution of all the commands in the transaction, so if a client loses the connection to the server in the context of a transaction before calling the <a href="http://redis.io/commands/multi" target="_blank" rel="external">MULTI</a> command none of the operations are performed, instead if the <a href="http://redis.io/commands/exec" target="_blank" rel="external">EXEC</a> command is called, all the operations are performed. When using the append-only file Redis makes sure to use a single write(2) syscall to write the transaction on disk. However if the Redis server crashes or is killed by the system administrator in some hard way it is possible that only a partial number of operations are registered. Redis will detect this condition at restart, and will exit with an error. Using the redis-check-aof tool it is possible to fix the append only file that will remove the partial transaction so that the server can start again.</li>
</ul>
<p>Starting with version 2.2, Redis allows for an extra guarantee to the above two, in the form of optimistic locking in a way very similar to a check-and-set (CAS) operation. This is documented later on this page.</p>
<h2>Usage</h2>
<p>A Redis transaction is entered using the <a href="http://redis.io/commands/multi" target="_blank" rel="external">MULTI</a> command. The command always replies with OK. At this point the user can issue multiple commands. Instead of executing these commands, Redis will queue them. All the commands are executed once <a href="http://redis.io/commands/exec" target="_blank" rel="external">EXEC</a> is called.<br>
Calling <a href="http://redis.io/commands/discard" target="_blank" rel="external">DISCARD</a> instead will flush the transaction queue and will exit the transaction.<br>
The following example increments keys foo and bar atomically.<br>
&gt; MULTI<br>
OK<br>
&gt; INCR foo<br>
QUEUED<br>
&gt; INCR bar<br>
QUEUED<br>
&gt; EXEC<br>
1) (integer) 1<br>
2) (integer) 1</p>
<p>As it is possible to see from the session above, <a href="http://redis.io/commands/exec" target="_blank" rel="external">EXEC</a> returns an array of replies, where every element is the reply of a single command in the transaction, in the same order the commands were issued.<br>
When a Redis connection is in the context of a <a href="http://redis.io/commands/multi" target="_blank" rel="external">MULTI</a> request, all commands will reply with the string QUEUED (sent as a Status Reply from the point of view of the Redis protocol). A queued command is simply scheduled for execution when <a href="http://redis.io/commands/exec" target="_blank" rel="external">EXEC</a> is called.</p>
<a id="more"></a>
<h2>Errors inside a transaction</h2>
<p>During a transaction it is possible to encounter two kind of command errors:</p>
<ul>
<li>A command may fail to be queued, so there may be an error before <a href="http://redis.io/commands/exec" target="_blank" rel="external">EXEC</a> is called. For instance the command may be syntactically wrong (wrong number of arguments, wrong command name, ...), or there may be some critical condition like an out of memory condition (if the server is configured to have a memory limit using the maxmemory directive).</li>
<li>A command may fail after <a href="http://redis.io/commands/exec" target="_blank" rel="external">EXEC</a> is called, for instance since we performed an operation against a key with the wrong value (like calling a list operation against a string value).</li>
</ul>
<p>Clients used to sense the first kind of errors, happening before the <a href="http://redis.io/commands/exec" target="_blank" rel="external">EXEC</a> call, by checking the return value of the queued command: if the command replies with QUEUED it was queued correctly, otherwise Redis returns an error. If there is an error while queueing a command, most clients will abort the transaction discarding it.<br>
However starting with Redis 2.6.5, the server will remember that there was an error during the accumulation of commands, and will refuse to execute the transaction returning also an error during <a href="http://redis.io/commands/exec" target="_blank" rel="external">EXEC</a>, and discarding the transaction automatically.<br>
Before Redis 2.6.5 the behavior was to execute the transaction with just the subset of commands queued successfully in case the client called <a href="http://redis.io/commands/exec" target="_blank" rel="external">EXEC</a> regardless of previous errors. The new behavior makes it much more simple to mix transactions with pipelining, so that the whole transaction can be sent at once, reading all the replies later at once.<br>
Errors happening after <a href="http://redis.io/commands/exec" target="_blank" rel="external">EXEC</a> instead are not handled in a special way: all the other commands will be executed even if some command fails during the transaction.<br>
This is more clear on the protocol level. In the following example one command will fail when executed even if the syntax is right:</p>
<pre><code>Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
MULTI
+OK
SET a 3
abc
+QUEUED
LPOP a
+QUEUED
EXEC
*2
+OK
-ERR Operation against a key holding the wrong kind of value
</code></pre>
<p><a href="http://redis.io/commands/exec" target="_blank" rel="external">EXEC</a> returned two-element Bulk string reply where one is an OK code and the other an -ERR reply. It's up to the client library to find a sensible way to provide the error to the user.<br>
It's important to note that <strong>even when a command fails, all the other commands in the queue are processed</strong> – Redis will not stop the processing of commands.<br>
Another example, again using the wire protocol with telnet, shows how syntax errors are reported ASAP instead:</p>
<pre><code>MULTI
+OK
INCR a b c
-ERR wrong number of arguments for 'incr' command
</code></pre>
<p>This time due to the syntax error the bad INCR command is not queued at all.</p>
<h2>Why Redis does not support roll backs?</h2>
<p>If you have a relational databases background, the fact that Redis commands can fail during a transaction, but still Redis will execute the rest of the transaction instead of rolling back, may look odd to you.<br>
However there are good opinions for this behavior:</p>
<ul>
<li>Redis commands can fail only if called with a wrong syntax (and the problem is not detectable during the command queueing), or against keys holding the wrong data type: this means that in practical terms a failing command is the result of a programming errors, and a kind of error that is very likely to be detected during development, and not in production.</li>
<li>Redis is internally simplified and faster because it does not need the ability to roll back.</li>
</ul>
<p>An argument against Redis point of view is that bugs happen, however it should be noted that in general the roll back does not save you from programming errors. For instance if a query increments a key by 2 instead of 1, or increments the wrong key, there is no way for a rollback mechanism to help. Given that no one can save the programmer from his errors, and that the kind of errors required for a Redis command to fail are unlikely to enter in production, we selected the simpler and faster approach of not supporting roll backs on errors.</p>
<h2>Discarding the command queue</h2>
<p><a href="http://redis.io/commands/discard" target="_blank" rel="external">DISCARD</a> can be used in order to abort a transaction. In this case, no commands are executed and the state of the connection is restored to normal.</p>
<pre><code>&gt; SET foo 1
OK
&gt; MULTI
OK
&gt; INCR foo
QUEUED
&gt; DISCARD
OK
&gt; GET foo
&quot;1&quot;
</code></pre>
<h2>Optimistic locking using check-and-set</h2>
<p><a href="http://redis.io/commands/watch" target="_blank" rel="external">WATCH</a> is used to provide a check-and-set (CAS) behavior to Redis transactions.<br>
<a href="http://redis.io/commands/watch" target="_blank" rel="external">WATCH</a>ed keys are monitored in order to detect changes against them. If at least one watched key is modified before the <a href="http://redis.io/commands/exec" target="_blank" rel="external">EXEC</a> command, the whole transaction aborts, and <a href="http://redis.io/commands/exec" target="_blank" rel="external">EXEC</a> returns a Null reply to notify that the transaction failed.<br>
For example, imagine we have the need to atomically increment the value of a key by 1 (let's suppose Redis doesn't have INCR).<br>
The first try may be the following:</p>
<pre><code>val = GET mykey
val = val + 1
SET mykey $val
</code></pre>
<p>This will work reliably only if we have a single client performing the operation in a given time. If multiple clients try to increment the key at about the same time there will be a race condition. For instance, client A and B will read the old value, for instance, 10. The value will be incremented to 11 by both the clients, and finally SET as the value of the key. So the final value will be 11 instead of 12.<br>
Thanks to <a href="http://redis.io/commands/watch" target="_blank" rel="external">WATCH</a> we are able to model the problem very well:</p>
<pre><code>WATCH mykey
val = GET mykey
val = val + 1
MULTI
SET mykey $val
EXEC
</code></pre>
<p>Using the above code, if there are race conditions and another client modifies the result of val in the time between our call to <a href="http://redis.io/commands/watch" target="_blank" rel="external">WATCH</a> and our call to <a href="http://redis.io/commands/exec" target="_blank" rel="external">EXEC</a>, the transaction will fail.<br>
We just have to repeat the operation hoping this time we'll not get a new race. This form of locking is called optimistic locking and is a very powerful form of locking. In many use cases, multiple clients will be accessing different keys, so collisions are unlikely – usually there's no need to repeat the operation.</p>
<h2><a href="http://redis.io/commands/watch" target="_blank" rel="external">WATCH</a> explained</h2>
<p>So what is <a href="http://redis.io/commands/watch" target="_blank" rel="external">WATCH</a> really about? It is a command that will make the <a href="http://redis.io/commands/exec" target="_blank" rel="external">EXEC</a> conditional: we are asking Redis to perform the transaction only if no other client modified any of the WATCHed keys. Otherwise the transaction is not entered at all. (<strong>Note that if you <a href="http://redis.io/commands/watch" target="_blank" rel="external">WATCH</a> a volatile key and Redis expires the key after you WATCHed it, <a href="http://redis.io/commands/exec" target="_blank" rel="external">EXEC</a> will still work. More on this.</strong>)<br>
<a href="http://redis.io/commands/watch" target="_blank" rel="external">WATCH</a> can be called multiple times. Simply all the <a href="http://redis.io/commands/watch" target="_blank" rel="external">WATCH</a> calls will have the effects to watch for changes starting from the call, up to the moment <a href="http://redis.io/commands/exec" target="_blank" rel="external">EXEC</a> is called. You can also send any number of keys to a single <a href="http://redis.io/commands/watch" target="_blank" rel="external">WATCH</a> call.<br>
When <a href="http://redis.io/commands/exec" target="_blank" rel="external">EXEC</a> is called, all keys are UNWATCHed, regardless of whether the transaction was aborted or not. Also when a client connection is closed, everything gets UNWATCHed.<br>
It is also possible to use the <a href="http://redis.io/commands/unwatch" target="_blank" rel="external">UNWATCH</a> command (without arguments) in order to flush all the watched keys. Sometimes this is useful as we optimistically lock a few keys, since possibly we need to perform a transaction to alter those keys, but after reading the current content of the keys we don't want to proceed. When this happens we just call <a href="http://redis.io/commands/unwatch" target="_blank" rel="external">UNWATCH</a> so that the connection can already be used freely for new transactions.</p>
<h2>Using <a href="http://redis.io/commands/watch" target="_blank" rel="external">WATCH</a> to implement ZPOP</h2>
<p>A good example to illustrate how <a href="http://redis.io/commands/watch" target="_blank" rel="external">WATCH</a> can be used to create new atomic operations otherwise not supported by Redis is to implement ZPOP, that is a command that pops the element with the lower score from a sorted set in an atomic way. This is the simplest implementation:</p>
<pre><code>WATCH zset
element = ZRANGE zset 0 0
MULTI
ZREM zset element
EXEC
</code></pre>
<p>If <a href="http://redis.io/commands/exec" target="_blank" rel="external">EXEC</a> fails (i.e. returns a Null reply) we just repeat the operation.</p>
<h2>Redis scripting and transactions</h2>
<p>A Redis script is transactional by definition, so everything you can do with a Redis transaction, you can also do with a script, and usually the script will be both simpler and faster.<br>
This duplication is due to the fact that scripting was introduced in Redis 2.6 while transactions already existed long before. However we are unlikely to remove the support for transactions in the short time because it seems semantically opportune that even without resorting to Redis scripting it is still possible to avoid race conditions, especially since the implementation complexity of Redis transactions is minimal.<br>
However it is not impossible that in a non immediate future we'll see that the whole user base is just using scripts. If this happens we may deprecate and finally remove transactions.</p>
<h2>Jedis</h2>
<figure class="highlight java"><figcaption><span>usage</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">usage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Jedis jedis = RedisCreator.createJedis();</span><br><span class="line">  Transaction transaction = jedis.multi();</span><br><span class="line">  Response&lt;Long&gt; foo = transaction.incr(<span class="string">"foo"</span>);</span><br><span class="line">  Response&lt;Long&gt; bar = transaction.incr(<span class="string">"bar"</span>);</span><br><span class="line">  List&lt;Object&gt; results = transaction.exec();</span><br><span class="line">  jedis.close();</span><br><span class="line"></span><br><span class="line">  LOG.info(<span class="string">"foo: "</span> + foo.get());</span><br><span class="line">  LOG.info(<span class="string">"bar: "</span> + bar.get());</span><br><span class="line">  LOG.info(<span class="string">"results: "</span> + (Joiner.on(<span class="string">','</span>).join(results)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>[INFO ] 14:40:14,511  foo: 1
[INFO ] 14:40:14,511  bar: 1
[INFO ] 14:40:14,536  results: 1,1
</code></pre>
<figure class="highlight java"><figcaption><span>error</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Jedis jedis = RedisCreator.createJedis();</span><br><span class="line">  Transaction transaction = jedis.multi();</span><br><span class="line">  Response&lt;String&gt; r1 = transaction.set(<span class="string">"a"</span>, <span class="string">"1"</span>);</span><br><span class="line">  Response&lt;String&gt; r2 = transaction.lpop(<span class="string">"a"</span>);</span><br><span class="line">  Response&lt;String&gt; r3 = transaction.set(<span class="string">"a"</span>, <span class="string">"2"</span>);</span><br><span class="line">  List&lt;Object&gt; results = transaction.exec();</span><br><span class="line">  jedis.close();</span><br><span class="line"></span><br><span class="line">  LOG.info(<span class="string">"r1: "</span> + r1.get());</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    LOG.info(<span class="string">"r2: "</span> + r2.get());</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    LOG.warn(<span class="string">"r2 get() throw a exception"</span>, e);</span><br><span class="line">  &#125;</span><br><span class="line">  LOG.info(<span class="string">"r3: "</span> + r3.get());</span><br><span class="line">  LOG.info(<span class="string">"results: "</span> + (Joiner.on(<span class="string">','</span>).join(results)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>[INFO ] 14:42:12,900  r1: OK
[WARN ] 14:42:12,901  r2 get() throw a exception
redis.clients.jedis.exceptions.JedisDataException: WRONGTYPE Operation against a key holding the wrong kind of value
  at redis.clients.jedis.Protocol.processError(Protocol.java:117)
  at redis.clients.jedis.Protocol.process(Protocol.java:142)
  at redis.clients.jedis.Protocol.processMultiBulkReply(Protocol.java:187)
  at redis.clients.jedis.Protocol.process(Protocol.java:138)
  at redis.clients.jedis.Protocol.read(Protocol.java:196)
  at redis.clients.jedis.Connection.readProtocolWithCheckingBroken(Connection.java:288)
  at redis.clients.jedis.Connection.getRawObjectMultiBulkReply(Connection.java:233)
  at redis.clients.jedis.Connection.getObjectMultiBulkReply(Connection.java:239)
  at redis.clients.jedis.Transaction.exec(Transaction.java:38)
  at com.github.dangxia.jedis.RedisTransactions.error(RedisTransactions.java:39)
  at com.github.dangxia.jedis.RedisTransactions.main(RedisTransactions.java:53)
[INFO ] 14:42:12,904  r3: OK
[INFO ] 14:42:12,908  results: OK,redis.clients.jedis.exceptions.JedisDataException: WRONGTYPE Operation against a key holding the wrong kind of value,OK
</code></pre>
<figure class="highlight java"><figcaption><span>testWatchFailed</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testWatchFailed</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">final</span> CountDownLatch countDownLatch2 = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        Jedis jedis = RedisCreator.createJedis();</span><br><span class="line">        jedis.set(WATCHED_KEY, <span class="string">"10"</span>);</span><br><span class="line">        jedis.close();</span><br><span class="line">        countDownLatch2.countDown();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;.start();</span><br><span class="line">  Jedis jedis = RedisCreator.createJedis();</span><br><span class="line">  jedis.set(WATCHED_KEY, <span class="string">"10"</span>);</span><br><span class="line">  jedis.watch(WATCHED_KEY);</span><br><span class="line">  countDownLatch.countDown();</span><br><span class="line">  countDownLatch2.await();</span><br><span class="line">  Transaction transaction = jedis.multi();</span><br><span class="line">  Response&lt;String&gt; setResp = transaction.set(WATCHED_KEY, <span class="string">"1"</span>);</span><br><span class="line">  List&lt;Object&gt; results = transaction.exec();</span><br><span class="line">  jedis.close();</span><br><span class="line">  LOG.info(<span class="string">"results :"</span> + String.valueOf(results));</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    LOG.info(<span class="string">"setResp :"</span> + String.valueOf(setResp.get()));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    LOG.warn(<span class="string">"watched keys changed"</span>, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>[INFO ] 14:44:04,185  results :null
[WARN ] 14:44:04,186  watched keys changed
redis.clients.jedis.exceptions.JedisDataException: Please close pipeline or multi block before calling this method.
  at redis.clients.jedis.Response.get(Response.java:33)
  at com.github.dangxia.jedis.RedisTransactions.testWatchFailed(RedisTransactions.java:83)
  at com.github.dangxia.jedis.RedisTransactions.main(RedisTransactions.java:53)
</code></pre>
<figure class="highlight java"><figcaption><span>CAS</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testWatch</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">  Jedis jedis = RedisCreator.createJedis();</span><br><span class="line">  jedis.del(WATCHED_KEY);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> threadNum = <span class="number">10</span>;</span><br><span class="line">  CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(threadNum);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; threadNum; i++) &#123;</span><br><span class="line">    <span class="keyword">new</span> Incr(countDownLatch).start();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  countDownLatch.await();</span><br><span class="line"></span><br><span class="line">  LOG.info(jedis.get(WATCHED_KEY));</span><br><span class="line">  jedis.close();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Incr</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Jedis jedis;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> CountDownLatch countDownLatch;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">long</span> retryTimes = <span class="number">0l</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Incr</span><span class="params">(CountDownLatch countDownLatch)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.jedis = RedisCreator.createJedis();</span><br><span class="line">    <span class="keyword">this</span>.countDownLatch = countDownLatch;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">incr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (doIncr()) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        retryTimes++;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">doIncr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    jedis.watch(WATCHED_KEY);</span><br><span class="line">    String val = jedis.get(WATCHED_KEY);</span><br><span class="line">    Transaction transaction = jedis.multi();</span><br><span class="line">    <span class="keyword">if</span> (val == <span class="keyword">null</span>) &#123;</span><br><span class="line">      transaction.set(WATCHED_KEY, <span class="string">"1"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      transaction.set(WATCHED_KEY,</span><br><span class="line">          String.valueOf(Integer.parseInt(val) + <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;Object&gt; results = transaction.exec();</span><br><span class="line">    <span class="keyword">if</span> (results == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i++ &lt; <span class="number">100</span>) &#123;</span><br><span class="line">      incr();</span><br><span class="line">    &#125;</span><br><span class="line">    LOG.info(getName() + <span class="string">" retry "</span> + retryTimes + <span class="string">" times"</span>);</span><br><span class="line">    jedis.close();</span><br><span class="line">    countDownLatch.countDown();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>[INFO ] 14:46:22,540  Thread-7 retry 376 times
[INFO ] 14:46:24,389  Thread-2 retry 480 times
[INFO ] 14:46:25,673  Thread-6 retry 542 times
[INFO ] 14:46:25,802  Thread-1 retry 570 times
[INFO ] 14:46:26,843  Thread-5 retry 616 times
[INFO ] 14:46:27,093  Thread-8 retry 631 times
[INFO ] 14:46:27,275  Thread-0 retry 650 times
[INFO ] 14:46:27,638  Thread-4 retry 660 times
[INFO ] 14:46:28,060  Thread-9 retry 672 times
[INFO ] 14:46:28,794  Thread-3 retry 696 times
[INFO ] 14:46:28,800  1000
</code></pre>
<h2>copy from</h2>
<p><a href="http://redis.io/topics/transactions" target="_blank" rel="external">transactions</a></p>

      
    </div>
    
    <div>
      
        
      
    </div>

    <div>
      
        
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/redis/" rel="tag">#redis</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/07/02/redis/redis-pipelining/" rel="next" title="Request/Response protocols and RTT">
                <i class="fa fa-chevron-left"></i> Request/Response protocols and RTT
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2015/07/03/redis/redis-eval/" rel="prev" title="redis-eval">
                redis-eval <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2015/07/03/redis/redis-transactions/"
           data-title="redis-transactions" data-url="http://dangxia.github.io/2015/07/03/redis/redis-transactions/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/img/logo.svg"
               alt="Xuehui He" />
          <p class="site-author-name" itemprop="name">Xuehui He</p>
          <p class="site-description motion-element" itemprop="description">面朝大海，春暖花开</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">83</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">23</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">13</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/dangxia" target="_blank" title="github">
                  
                    <i class="fa fa-globe"></i>
                  
                  github
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">1.</span> <span class="nav-text">Usage</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">2.</span> <span class="nav-text">Errors inside a transaction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">3.</span> <span class="nav-text">Why Redis does not support roll backs?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">4.</span> <span class="nav-text">Discarding the command queue</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">5.</span> <span class="nav-text">Optimistic locking using check-and-set</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">6.</span> <span class="nav-text">WATCH explained</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">7.</span> <span class="nav-text">Using WATCH to implement ZPOP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">8.</span> <span class="nav-text">Redis scripting and transactions</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">9.</span> <span class="nav-text">Jedis</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">10.</span> <span class="nav-text">copy from</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2013 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xuehui He</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>


  
  <script type="text/javascript" src="/english.js"></script>

  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"xuehuihe-java"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  
  

  

  

</body>
</html>
